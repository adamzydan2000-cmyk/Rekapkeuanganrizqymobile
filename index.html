<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIZQY MOBILE</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body { font-family: sans-serif; background: #121212; margin: 0; padding-bottom: 90px; color: #e0e0e0; }
        .header { background: #4f46e5; color: white; text-align: center; padding: 15px; position: sticky; top: 0; z-index: 100; }
        .header h1 { margin: 0; font-size: 18px; letter-spacing: 1px; }
        #navbar { position: fixed; bottom: 0; left: 0; width: 100%; background: #1e1e1e; display: flex; border-top: 1px solid #333; height: 70px; z-index: 999; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: #888; border: none; background: none; }
        .nav-item.active { color: #818cf8; font-weight: bold; }
        .nav-item span { font-size: 22px; margin-bottom: 4px; }
        .content { display: none; padding: 15px; }
        .content.active { display: block; }
        .card { background: #1e1e1e; border-radius: 12px; padding: 15px; border: 1px solid #333; margin-bottom: 10px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #444; border-radius: 8px; font-size: 14px; background: #252525; color: white; text-align: center; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; margin-bottom: 10px; color: white; }
        .btn-blue { background: #4f46e5; }
        .btn-green { background: #10b981; }
        .btn-red { background: #ef4444; }
        .btn-dark { background: #2d3748; }
        .rep-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .rep-label { flex: 1.5; font-size: 12px; font-weight: bold; color: #bbb; }
        .rep-input { flex: 1; margin-bottom: 0 !important; padding: 8px !important; }
        .rep-total { flex: 1; background: #2d2d2d !important; font-weight: bold; border-color: #444; }
        .list-box { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 5px solid #4f46e5; position: relative; border: 1px solid #333; font-size: 13px; }
        .del-x { position: absolute; right: 12px; top: 12px; color: #ef4444; font-weight: bold; font-size: 18px; padding: 5px; }
        .flex { display: flex; gap: 8px; }
        .hidden { display: none; }
        .btn-del-row { background: #ef4444; border: none; color: white; border-radius: 5px; padding: 0 10px; font-weight: bold; cursor: pointer; }
        .pay-box { background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #333; margin-bottom: 10px; }
        .pay-label { font-size: 10px; color: #888; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .total-banner { background: #10b981; color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 16px; border: 1px solid #059669; }
    </style>
</head>
<body>
    <div class="header">
        <h1>RIZQY MOBILE</h1>
    </div>

    <div id="tab-rekap" class="content active">
        <div class="card">
            <select id="uIn" style="color: #818cf8; font-weight: bold;">
                <option>Adam</option><option>Mas Rifai</option><option>Mas Fajar</option><option>Mas Satria</option><option>Mas Ali</option>
            </select>
            
            <div class="flex">
                <select id="tipeCust" style="flex:0.8" onchange="toggleCustInput()">
                    <option value="Orang">üë§ Orang</option>
                    <option value="COD">üì¶ COD</option>
                </select>
                <input type="number" id="valCust" placeholder="Jml Orang" style="flex:1" value="1">
            </div>

            <div class="flex">
                <select id="tIn" style="flex:1" onchange="logicForm()"><option value="HP">üì± HP</option><option value="ACC">üéß ACC</option></select>
                <select id="bIn" style="flex:1"><option>Oppo</option><option>Realme</option><option>Vivo</option><option>Samsung</option><option>Xiaomi</option><option>Infinix</option><option>Nokia</option><option>Other</option></select>
            </div>
            
            <div id="divHP">
                <input type="text" id="namaHP" placeholder="Tipe HP">
                <label style="font-size: 12px; display: block; margin-bottom: 10px; color:#bbb;"><input type="checkbox" id="cekAcc" onchange="logicForm()"> + Aksesoris?</label>
            </div>

            <div id="divAcc" class="hidden" style="background: #252525; padding: 10px; border: 1px dashed #4f46e5; border-radius: 8px; margin-bottom: 10px;">
                <div id="accCont">
                    <div class="flex acc-row" style="margin-bottom:5px;">
                        <input type="number" class="akode" placeholder="Kd" style="flex:0.4">
                        <input type="text" class="anama" placeholder="Nama Barang" style="flex:1">
                    </div>
                </div>
                <button onclick="tambahBaris()" type="button" style="width:100%; font-size:10px; padding:8px; background:none; border:1px solid #444; color:#aaa; border-radius:5px;">+ TAMBAH BARIS</button>
            </div>

            <div class="pay-box">
                <span class="pay-label">Metode Pembayaran</span>
                <div id="payCont">
                    <div class="flex pay-row" style="margin-bottom:5px;">
                        <select class="pmeth" style="flex:1; margin-bottom:0;">
                            <option value="Cash">Cash</option>
                            <option value="Debit BCA">Debit BCA</option>
                            <option value="Bca admin Syalsa">Bca admin Syalsa</option>
                            <option value="BCA admin Ika">BCA admin Ika</option>
                        </select>
                        <input type="number" class="pnom" placeholder="Nominal" style="flex:1; margin-bottom:0;">
                    </div>
                </div>
                <button onclick="tambahPayment()" type="button" style="width:100%; font-size:10px; padding:8px; background:none; border:1px solid #444; color:#818cf8; border-radius:5px; margin-top:5px;">+ SPLIT PAYMENT</button>
            </div>

            <button onclick="saveRekap()" class="btn btn-blue">SIMPAN TRANSAKSI</button>
            <button onclick="exportExcel()" class="btn btn-dark" style="font-size: 11px;">üìä DOWNLOAD DATA (.CSV)</button>
        </div>
        
        <div id="bannerTotal" class="total-banner hidden">TOTAL: Rp 0</div>
        <div id="listRekap"></div>
    </div>

    <div id="tab-out" class="content">
        <div class="card">
            <input type="text" id="oKet" placeholder="Keterangan">
            <input type="number" id="oNom" placeholder="Nominal Rp">
            <button onclick="saveOut()" class="btn btn-red">SIMPAN PENGELUARAN</button>
        </div>
        <div id="listOut"></div>
    </div>

    <div id="tab-report" class="content">
        <div class="card">
            <h3 style="text-align: center; margin-top: 0; color: #818cf8; font-size: 16px;">REKAP HARIAN</h3>
            <input type="date" id="tglRep" style="font-weight: bold;">
            <div id="brandArea"></div>
            <div id="othArea"></div>
            <button onclick="preview()" class="btn btn-blue" style="margin-top: 15px;">PREVIEW LAPORAN</button>
            <div id="boxPrev" class="hidden" style="background:#fff; color:#000; padding:10px; font-family:monospace; font-size:11px; margin-top:10px; white-space:pre-wrap;"></div>
            <button onclick="copyWA()" class="btn btn-green">SALIN WA</button>
        </div>
    </div>

    <div id="navbar">
        <button class="nav-item active" onclick="tab('tab-rekap', this)"><span>üìù</span>Rekap</button>
        <button class="nav-item" onclick="tab('tab-out', this)"><span>üì§</span>Out</button>
        <button class="nav-item" onclick="tab('tab-report', this)"><span>üìä</span>Report</button>
    </div>

    <script>
        const B = [{id:'op',n:'Oppo',t:70},{id:'rm',n:'Realme',t:50},{id:'vv',n:'Vivo',t:20},{id:'ss',n:'Samsung',t:100},{id:'xi',n:'Xiaomi',t:45},{id:'if',n:'Infinix',t:30}];
        const O = [{id:'nk',n:'Nokia'},{id:'ot',n:'Other'},{id:'sc',n:'Second'},{id:'sp',n:'Sepeda'}];
        
        function toggleCustInput() {
            const tipe = document.getElementById('tipeCust').value;
            const input = document.getElementById('valCust');
            if(tipe === 'COD') {
                input.value = ""; input.placeholder = "Ket COD"; input.type = "text";
            } else {
                input.value = "1"; input.placeholder = "Jml Orang"; input.type = "number";
            }
        }

        function tab(id, el) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        function logicForm() {
            const t = document.getElementById('tIn').value;
            document.getElementById('divHP').style.display = t === 'HP' ? 'block' : 'none';
            document.getElementById('bIn').style.display = t === 'HP' ? 'block' : 'none';
            document.getElementById('divAcc').classList.toggle('hidden', t !== 'ACC' && !document.getElementById('cekAcc').checked);
        }

        function tambahBaris() {
            const row = document.createElement('div');
            row.className = 'flex acc-row'; row.style.marginTop = '5px';
            row.innerHTML = `<input type="number" class="akode" placeholder="Kd" style="flex:0.4"><input type="text" class="anama" placeholder="Nama Barang" style="flex:1"><button class="btn-del-row" onclick="this.parentElement.remove()">‚úï</button>`;
            document.getElementById('accCont').appendChild(row);
        }

        function tambahPayment() {
            const row = document.createElement('div');
            row.className = 'flex pay-row'; row.style.marginTop = '5px';
            row.innerHTML = `<select class="pmeth" style="flex:1; margin-bottom:0;"><option value="Cash">Cash</option><option value="Debit BCA">Debit BCA</option><option value="Bca admin Syalsa">Bca admin Syalsa</option><option value="BCA admin Ika">BCA admin Ika</option></select><input type="number" class="pnom" placeholder="Nominal" style="flex:1; margin-bottom:0;"><button class="btn-del-row" onclick="this.parentElement.remove()">‚úï</button>`;
            document.getElementById('payCont').appendChild(row);
        }

        function saveRekap() {
            const tipeC = document.getElementById('tipeCust').value;
            const valC = document.getElementById('valCust').value;
            const methods = document.querySelectorAll('.pmeth');
            const amounts = document.querySelectorAll('.pnom');
            let totalV = 0; let payDetails = [];

            amounts.forEach((el, idx) => {
                let v = parseInt(el.value || 0);
                if(v > 0) { totalV += v; payDetails.push(`${methods[idx].value}: ${v}`); }
            });

            if(totalV <= 0) return alert("Isi nominal!");

            const kodes = document.querySelectorAll('.akode');
            const namas = document.querySelectorAll('.anama');
            let accs = [];
            namas.forEach((el, idx) => { if(el.value) accs.push(`${el.value} [${kodes[idx].value || '-'}]`); });
            
            let detail = document.getElementById('tIn').value === 'HP' ? document.getElementById('namaHP').value : "";
            const list = JSON.parse(localStorage.getItem('RZ_L_REKAP')) || [];
            list.push({ 
                u: document.getElementById('uIn').value, 
                c: `${tipeC}: ${valC}`,
                b: document.getElementById('tIn').value === 'ACC' ? 'Aksesoris' : document.getElementById('bIn').value, 
                i: detail + (accs.length > 0 ? (detail ? " + " : "") + accs.join(", ") : ""), 
                v: totalV,
                p: payDetails.join(" | ")
            });
            
            localStorage.setItem('RZ_L_REKAP', JSON.stringify(list));
            alert("Berhasil!");
            showRekap();
        }

        function showRekap() {
            const list = JSON.parse(localStorage.getItem('RZ_L_REKAP')) || [];
            let total = 0;
            document.getElementById('listRekap').innerHTML = list.map((x,i)=> {
                total += x.v;
                return `<div class="list-box"><div class="del-x" onclick="delR(${i})">‚úï</div><b>${x.u} | ${x.b}</b> <span style="font-size:10px; background:#444; padding:2px 5px; border-radius:4px;">${x.c}</span><br><small>${x.i}</small><br><small style="color:#818cf8">${x.p}</small><br><b style="color:#34d399;">Rp ${x.v.toLocaleString()}</b></div>`;
            }).reverse().join('');
            
            const banner = document.getElementById('bannerTotal');
            if(list.length > 0) {
                banner.innerText = `TOTAL PEMASUKAN: Rp ${total.toLocaleString()}`;
                banner.classList.remove('hidden');
            } else { banner.classList.add('hidden'); }
        }

        function delR(i) { if(confirm("Hapus?")) { let list = JSON.parse(localStorage.getItem('RZ_L_REKAP')); list.splice(i,1); localStorage.setItem('RZ_L_REKAP', JSON.stringify(list)); showRekap(); } }

        // FUNGSI DOWNLOAD BARU (LEBIH KUAT)
        function exportExcel() {
            const list = JSON.parse(localStorage.getItem('RZ_L_REKAP')) || [];
            if(list.length === 0) return alert("Data kosong!");

            let csvContent = "\uFEFF"; // BOM untuk Excel agar tidak berantakan
            csvContent += "User,Customer,Brand,Detail,Pembayaran,Total\n";

            list.forEach(x => {
                let row = [
                    x.u,
                    x.c,
                    x.b,
                    `"${x.i.replace(/"/g, '""')}"`,
                    `"${x.p.replace(/"/g, '""')}"`,
                    x.v
                ].join(",");
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            
            const date = new Date().toISOString().slice(0,10);
            link.setAttribute("href", url);
            link.setAttribute("download", `Rekap_Rizqy_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function saveOut() {
            const n = document.getElementById('oKet').value; const v = parseInt(document.getElementById('oNom').value || 0);
            if(!n || v <= 0) return alert("Lengkapi!");
            const list = JSON.parse(localStorage.getItem('RZ_L_OUT')) || [];
            list.push({n, v}); localStorage.setItem('RZ_L_OUT', JSON.stringify(list));
            showOut();
        }

        function showOut() {
            const list = JSON.parse(localStorage.getItem('RZ_L_OUT')) || [];
            document.getElementById('listOut').innerHTML = list.map((x,i)=>`<div class="list-box" style="border-left-color:red;"><div class="del-x" onclick="delO(${i})">‚úï</div><b>${x.n}</b><br><b style="color:#f87171;">Rp ${x.v.toLocaleString()}</b></div>`).reverse().join('');
        }

        function delO(i) { if(confirm("Hapus?")) { let list = JSON.parse(localStorage.getItem('RZ_L_OUT')); list.splice(i,1); localStorage.setItem('RZ_L_OUT', JSON.stringify(list)); showOut(); } }

        window.onload = () => { showRekap(); showOut(); logicForm(); };
    </script>
</body>
</html>
